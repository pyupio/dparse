name: PyPi Release

on: workflow_dispatch

jobs:
    pypi-publish:
      name: upload release to PyPI
      runs-on: ubuntu-latest
      environment: release
      permissions:
          id-token: write
      steps:
          - uses: actions/download-artifact@v3
            with:
              name: dist-release
              path: dist
          - name: Publish package distributions to PyPI
            uses: pypa/gh-action-pypi-publish@release/v1
            with:
              print-hash: true

    repo-release:
      needs: pypi-publish
      name: GitHub release
      runs-on: ubuntu-latest
      steps:
        - name: TAG version
          id: tag
          run: |
            TAG_VERSION=$(hatch version)
            echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_OUTPUT

        - name: Release
          uses: softprops/action-gh-release@v1
          with:
            body_path: "CHANGELOG.md"
            tag_name: ${{ steps.tag.outputs.TAG_VERSION }}
